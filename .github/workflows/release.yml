name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # Validate version consistency
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate VERSION matches tag
        run: |
          FILE_VERSION=$(cat VERSION)
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          echo "VERSION file: ${FILE_VERSION}"
          echo "Git tag:      v${TAG_VERSION}"

          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo ""
            echo "ERROR: VERSION file ($FILE_VERSION) does not match git tag (v$TAG_VERSION)"
            echo ""
            echo "To fix this:"
            echo "  1. Update VERSION file to: $TAG_VERSION"
            echo "  2. Or delete the tag and create a new one matching VERSION: v$FILE_VERSION"
            exit 1
          fi

          echo ""
          echo "Version validated: v${FILE_VERSION}"

  # Build and test Linux AMD64
  build-linux-amd64:
    name: Build & Test Linux AMD64
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Build Linux AMD64 binary
        run: |
          LDFLAGS="-s -w"
          LDFLAGS="${LDFLAGS} -X 'main.Version=${{ steps.version.outputs.VERSION }}'"
          LDFLAGS="${LDFLAGS} -X 'main.BuildTime=$(date -u +"%Y-%m-%d %H:%M:%S UTC")'"
          LDFLAGS="${LDFLAGS} -X 'main.GitCommit=$(git rev-parse --short HEAD)'"

          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="${LDFLAGS}" \
            -o "p2kb-mcp-v${{ steps.version.outputs.VERSION }}-linux-amd64" \
            ./cmd/p2kb-mcp

      - name: Smoke test - Version
        run: |
          ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-linux-amd64 --version
          ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-linux-amd64 --version | grep -q "${{ steps.version.outputs.VERSION }}"

      - name: Smoke test - MCP tools/list
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | \
            timeout 5 ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-linux-amd64 | \
            grep -q "p2kb_get"

      - name: Upload Linux AMD64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux-amd64-${{ github.ref_name }}
          path: p2kb-mcp-v*-linux-amd64
          retention-days: 1

  # Build Linux ARM64 (cross-compiled)
  build-linux-arm64:
    name: Build Linux ARM64 (cross-compile)
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Build Linux ARM64 binary
        run: |
          LDFLAGS="-s -w"
          LDFLAGS="${LDFLAGS} -X 'main.Version=${{ steps.version.outputs.VERSION }}'"
          LDFLAGS="${LDFLAGS} -X 'main.BuildTime=$(date -u +"%Y-%m-%d %H:%M:%S UTC")'"
          LDFLAGS="${LDFLAGS} -X 'main.GitCommit=$(git rev-parse --short HEAD)'"

          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
            -ldflags="${LDFLAGS}" \
            -o "p2kb-mcp-v${{ steps.version.outputs.VERSION }}-linux-arm64" \
            ./cmd/p2kb-mcp

      - name: Verify binary was created
        run: |
          ls -la p2kb-mcp-v${{ steps.version.outputs.VERSION }}-linux-arm64
          file p2kb-mcp-v${{ steps.version.outputs.VERSION }}-linux-arm64 | grep -q "ARM aarch64"
          echo "Binary architecture verified as ARM64"

      - name: Upload Linux ARM64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux-arm64-${{ github.ref_name }}
          path: p2kb-mcp-v*-linux-arm64
          retention-days: 1

  # Build and test macOS AMD64
  build-darwin-amd64:
    name: Build & Test macOS AMD64
    runs-on: macos-15-large
    needs: validate-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Build macOS AMD64 binary
        run: |
          LDFLAGS="-s -w"
          LDFLAGS="${LDFLAGS} -X 'main.Version=${{ steps.version.outputs.VERSION }}'"
          LDFLAGS="${LDFLAGS} -X 'main.BuildTime=$(date -u +"%Y-%m-%d %H:%M:%S UTC")'"
          LDFLAGS="${LDFLAGS} -X 'main.GitCommit=$(git rev-parse --short HEAD)'"

          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build \
            -ldflags="${LDFLAGS}" \
            -o "p2kb-mcp-v${{ steps.version.outputs.VERSION }}-darwin-amd64" \
            ./cmd/p2kb-mcp

      - name: Smoke test - Version
        run: |
          ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-darwin-amd64 --version
          ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-darwin-amd64 --version | grep -q "${{ steps.version.outputs.VERSION }}"

      - name: Smoke test - MCP tools/list
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | \
            perl -e 'alarm 10; exec @ARGV' ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-darwin-amd64 | \
            head -100 | grep -q "p2kb_get"

      - name: Upload macOS AMD64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-darwin-amd64-${{ github.ref_name }}
          path: p2kb-mcp-v*-darwin-amd64
          retention-days: 1

  # Build and test macOS ARM64
  build-darwin-arm64:
    name: Build & Test macOS ARM64
    runs-on: macos-latest
    needs: validate-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Build macOS ARM64 binary
        run: |
          LDFLAGS="-s -w"
          LDFLAGS="${LDFLAGS} -X 'main.Version=${{ steps.version.outputs.VERSION }}'"
          LDFLAGS="${LDFLAGS} -X 'main.BuildTime=$(date -u +"%Y-%m-%d %H:%M:%S UTC")'"
          LDFLAGS="${LDFLAGS} -X 'main.GitCommit=$(git rev-parse --short HEAD)'"

          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build \
            -ldflags="${LDFLAGS}" \
            -o "p2kb-mcp-v${{ steps.version.outputs.VERSION }}-darwin-arm64" \
            ./cmd/p2kb-mcp

      - name: Smoke test - Version
        run: |
          ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-darwin-arm64 --version
          ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-darwin-arm64 --version | grep -q "${{ steps.version.outputs.VERSION }}"

      - name: Smoke test - MCP tools/list
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | \
            perl -e 'alarm 10; exec @ARGV' ./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-darwin-arm64 | \
            head -100 | grep -q "p2kb_get"

      - name: Upload macOS ARM64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-darwin-arm64-${{ github.ref_name }}
          path: p2kb-mcp-v*-darwin-arm64
          retention-days: 1

  # Build and test Windows AMD64
  build-windows-amd64:
    name: Build & Test Windows AMD64
    runs-on: windows-latest
    needs: validate-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get version
        id: version
        shell: bash
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Build Windows AMD64 binary
        shell: bash
        run: |
          LDFLAGS="-s -w"
          LDFLAGS="${LDFLAGS} -X 'main.Version=${{ steps.version.outputs.VERSION }}'"
          LDFLAGS="${LDFLAGS} -X 'main.BuildTime=$(date -u +"%Y-%m-%d %H:%M:%S UTC")'"
          LDFLAGS="${LDFLAGS} -X 'main.GitCommit=$(git rev-parse --short HEAD)'"

          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build \
            -ldflags="${LDFLAGS}" \
            -o "p2kb-mcp-v${{ steps.version.outputs.VERSION }}-windows-amd64.exe" \
            ./cmd/p2kb-mcp

      - name: Smoke test - Version
        shell: pwsh
        run: |
          $output = & "./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-windows-amd64.exe" --version 2>&1 | Out-String
          Write-Host "Version output: $output"
          if ($output -notlike "*${{ steps.version.outputs.VERSION }}*") {
            throw "Version mismatch: expected ${{ steps.version.outputs.VERSION }} in output"
          }

      - name: Smoke test - MCP tools/list
        shell: pwsh
        run: |
          $response = '{"jsonrpc":"2.0","id":1,"method":"tools/list"}' | & "./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-windows-amd64.exe"
          Write-Host $response
          if ($response -notmatch "p2kb_get") {
            throw "tools/list failed"
          }

      - name: Upload Windows AMD64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-windows-amd64-${{ github.ref_name }}
          path: p2kb-mcp-v*-windows-amd64.exe
          retention-days: 1

  # Build Windows ARM64
  build-windows-arm64:
    name: Build Windows ARM64
    runs-on: windows-latest
    needs: validate-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get version
        id: version
        shell: bash
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Build Windows ARM64 binary
        shell: bash
        run: |
          LDFLAGS="-s -w"
          LDFLAGS="${LDFLAGS} -X 'main.Version=${{ steps.version.outputs.VERSION }}'"
          LDFLAGS="${LDFLAGS} -X 'main.BuildTime=$(date -u +"%Y-%m-%d %H:%M:%S UTC")'"
          LDFLAGS="${LDFLAGS} -X 'main.GitCommit=$(git rev-parse --short HEAD)'"

          CGO_ENABLED=0 GOOS=windows GOARCH=arm64 go build \
            -ldflags="${LDFLAGS}" \
            -o "p2kb-mcp-v${{ steps.version.outputs.VERSION }}-windows-arm64.exe" \
            ./cmd/p2kb-mcp

      - name: Verify binary was created
        shell: pwsh
        run: |
          if (!(Test-Path "./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-windows-arm64.exe")) {
            throw "Binary was not created"
          }
          $size = (Get-Item "./p2kb-mcp-v${{ steps.version.outputs.VERSION }}-windows-arm64.exe").Length
          Write-Host "Binary size: $size bytes"
          if ($size -lt 1000000) {
            throw "Binary seems too small"
          }

      - name: Upload Windows ARM64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-windows-arm64-${{ github.ref_name }}
          path: p2kb-mcp-v*-windows-arm64.exe
          retention-days: 1

  # Assemble container-tools package using build script
  assemble-container-tools:
    name: Assemble Container Tools Package
    runs-on: ubuntu-latest
    needs:
      - build-linux-amd64
      - build-linux-arm64
      - build-darwin-amd64
      - build-darwin-arm64
      - build-windows-amd64
      - build-windows-arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Build container-tools package using repo script
        run: |
          # Run the build script which creates the full package with:
          # - Universal launcher with symlink resolution
          # - Full installer with --target, --uninstall, --help
          # - hooks-dispatcher.sh and hooks.d scripts
          # - Skip-if-identical optimization
          # - Rollback support
          ./scripts/build-container-tools.sh

      - name: Copy package to workspace root
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cp "builds/container-tools/container-tools-p2kb-mcp-v${VERSION}.tar.gz" .

      - name: Verify package contents
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Package contents:"
          tar -tzf "container-tools-p2kb-mcp-v${VERSION}.tar.gz" | head -30

      - name: Upload container-tools package
        uses: actions/upload-artifact@v4
        with:
          name: container-tools-package-${{ github.ref_name }}
          path: container-tools-p2kb-mcp-v*.tar.gz
          retention-days: 1

  # Create standalone packages
  assemble-standalone:
    name: Assemble Standalone Packages
    runs-on: ubuntu-latest
    needs:
      - build-linux-amd64
      - build-linux-arm64
      - build-darwin-amd64
      - build-darwin-arm64
      - build-windows-amd64
      - build-windows-arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: binaries/
          pattern: binary-*-${{ github.ref_name }}
          merge-multiple: true

      - name: Create standalone packages
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          MCP_NAME="p2kb-mcp"

          # Create packages for each platform
          for binary in binaries/*; do
            filename=$(basename "$binary")

            # Extract platform from filename (e.g., p2kb-mcp-v1.0.0-linux-amd64 -> linux-amd64)
            platform=$(echo "$filename" | sed "s/${MCP_NAME}-v${VERSION}-//" | sed 's/\.exe$//')

            echo "Creating package for ${platform}..."

            # Create package directory
            pkg_dir="pkg-${platform}/${MCP_NAME}"
            mkdir -p "${pkg_dir}/bin"

            # Copy binary
            if [[ "$filename" == *.exe ]]; then
              cp "$binary" "${pkg_dir}/bin/${MCP_NAME}.exe"
            else
              cp "$binary" "${pkg_dir}/bin/${MCP_NAME}"
              chmod +x "${pkg_dir}/bin/${MCP_NAME}"
            fi

            # Copy documentation
            cp README.md "${pkg_dir}/"
            cp CHANGELOG.md "${pkg_dir}/"
            cp LICENSE "${pkg_dir}/"

            # Create package
            cd "pkg-${platform}"
            if [[ "$platform" == windows* ]]; then
              zip -r "../${MCP_NAME}-v${VERSION}-${platform}.zip" "${MCP_NAME}"
            else
              tar -czf "../${MCP_NAME}-v${VERSION}-${platform}.tar.gz" "${MCP_NAME}"
            fi
            cd ..
          done

          echo "Created packages:"
          ls -la *.tar.gz *.zip 2>/dev/null || true

      - name: Upload standalone packages
        uses: actions/upload-artifact@v4
        with:
          name: standalone-packages-${{ github.ref_name }}
          path: |
            p2kb-mcp-v*.tar.gz
            p2kb-mcp-v*.zip
            !container-tools-p2kb-mcp-v*.tar.gz
          retention-days: 1

  # Sign macOS binaries (optional)
  sign-macos:
    name: Sign macOS Binaries
    runs-on: macos-latest
    needs: [build-darwin-amd64, build-darwin-arm64, assemble-container-tools]
    if: ${{ vars.MACOS_SIGNING_ENABLED == 'true' }}
    steps:
      - name: Download darwin-amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-darwin-amd64-${{ github.ref_name }}
          path: binaries/

      - name: Download darwin-arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-darwin-arm64-${{ github.ref_name }}
          path: binaries/

      - name: Download container-tools package
        uses: actions/download-artifact@v4
        with:
          name: container-tools-package-${{ github.ref_name }}
          path: package/

      - name: Import signing certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PWD: ${{ secrets.KEYCHAIN_PWD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo -n "$MACOS_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PWD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PWD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$MACOS_CERTIFICATE_PWD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PWD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Sign macOS binaries
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          for binary in binaries/*darwin*; do
            echo "Signing $binary..."
            codesign --force --options runtime \
              --sign "Developer ID Application: ${{ secrets.APPLE_DEVELOPER_NAME }} ($APPLE_TEAM_ID)" \
              --timestamp \
              "$binary"
            codesign --verify --verbose "$binary"
          done

      - name: Notarize binaries
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd binaries
          for binary in *darwin*; do
            echo "Notarizing $binary..."
            zip "${binary}.zip" "$binary"
            xcrun notarytool submit "${binary}.zip" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_ID_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait
            rm "${binary}.zip"
          done

      - name: Rebuild container-tools package with signed binaries
        run: |
          cd package
          # Extract version from tarball filename (container-tools-p2kb-mcp-vX.X.X.tar.gz)
          TARBALL=$(ls *.tar.gz | head -1)
          VERSION=$(echo "$TARBALL" | sed 's/container-tools-p2kb-mcp-v\(.*\)\.tar\.gz/\1/')
          echo "Detected version: ${VERSION}"

          tar -xzf "$TARBALL"
          rm "$TARBALL"

          # Package structure: container-tools-p2kb-mcp-vX.X.X/p2kb-mcp/
          MCP_NAME="p2kb-mcp"
          PACKAGE_DIR="container-tools-${MCP_NAME}-v${VERSION}"
          cp ../binaries/*darwin* "${PACKAGE_DIR}/${MCP_NAME}/bin/platforms/"
          tar -czf "container-tools-${MCP_NAME}-v${VERSION}.tar.gz" "${PACKAGE_DIR}"

      - name: Upload signed darwin-amd64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-darwin-amd64-signed-${{ github.ref_name }}
          path: binaries/*darwin-amd64*

      - name: Upload signed darwin-arm64 binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-darwin-arm64-signed-${{ github.ref_name }}
          path: binaries/*darwin-arm64*

      - name: Upload signed container-tools package
        uses: actions/upload-artifact@v4
        with:
          name: container-tools-package-signed-${{ github.ref_name }}
          path: package/*.tar.gz

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [assemble-container-tools, assemble-standalone, sign-macos]
    if: ${{ always() && needs.assemble-container-tools.result == 'success' && needs.assemble-standalone.result == 'success' && (needs.sign-macos.result == 'success' || needs.sign-macos.result == 'skipped') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download linux-amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-linux-amd64-${{ github.ref_name }}
          path: binaries/

      - name: Download linux-arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-linux-arm64-${{ github.ref_name }}
          path: binaries/

      - name: Download darwin-amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-darwin-amd64-${{ github.ref_name }}
          path: binaries/

      - name: Download darwin-arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-darwin-arm64-${{ github.ref_name }}
          path: binaries/

      - name: Download windows-amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-windows-amd64-${{ github.ref_name }}
          path: binaries/

      - name: Download windows-arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: binary-windows-arm64-${{ github.ref_name }}
          path: binaries/

      - name: Download container-tools package
        uses: actions/download-artifact@v4
        with:
          name: container-tools-package-${{ github.ref_name }}
          path: packages/

      - name: Download standalone packages
        uses: actions/download-artifact@v4
        with:
          name: standalone-packages-${{ github.ref_name }}
          path: standalone/

      - name: Download signed darwin-amd64 binary (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: binary-darwin-amd64-signed-${{ github.ref_name }}
          path: binaries-signed/

      - name: Download signed darwin-arm64 binary (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: binary-darwin-arm64-signed-${{ github.ref_name }}
          path: binaries-signed/

      - name: Download signed container-tools package (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: container-tools-package-signed-${{ github.ref_name }}
          path: packages-signed/

      - name: Use signed artifacts if available
        run: |
          if [ -d "packages-signed" ] && [ "$(ls -A packages-signed 2>/dev/null)" ]; then
            echo "Using signed container-tools package"
            rm -rf packages/*
            mv packages-signed/* packages/
            echo "SIGNED=true" >> $GITHUB_ENV
          else
            echo "Using unsigned container-tools package"
            echo "SIGNED=false" >> $GITHUB_ENV
          fi

          if [ -d "binaries-signed" ] && [ "$(ls -A binaries-signed 2>/dev/null)" ]; then
            echo "Using signed darwin binaries"
            for signed in binaries-signed/*; do
              if [ -f "$signed" ]; then
                echo "  Replacing with signed: $(basename $signed)"
                cp "$signed" binaries/
              fi
            done
          fi

      - name: Assemble release artifacts
        run: |
          mkdir -p release

          # Copy standalone packages
          cp standalone/*.tar.gz release/ 2>/dev/null || true
          cp standalone/*.zip release/ 2>/dev/null || true

          # Copy container-tools package
          cp packages/*.tar.gz release/

      - name: List release artifacts
        run: |
          echo "Release artifacts:"
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          echo ""
          echo "Checksums:"
          cat checksums.txt

      - name: Check if signed
        id: check-signed
        run: |
          if [ "$SIGNED" = "true" ]; then
            echo "MACOS_NOTE=macOS binaries are signed and notarized." >> $GITHUB_OUTPUT
          else
            echo "MACOS_NOTE=macOS binaries are unsigned. Run \`xattr -d com.apple.quarantine <binary>\` after download." >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            release/*
          body: |
            ## P2KB MCP ${{ steps.version.outputs.VERSION }}

            MCP server providing access to the Propeller 2 Knowledge Base for Claude.

            ---

            ### Option 1: Container-Tools Package (Recommended for /opt/container-tools/)

            Multi-platform package for container-tools installations. Includes binaries for all platforms.

            ```bash
            # Download and extract
            tar -xzf container-tools-p2kb-mcp-${{ steps.version.outputs.VERSION }}.tar.gz
            cd p2kb-mcp

            # Install
            sudo ./install.sh

            # Verify
            /opt/container-tools/bin/p2kb-mcp --version
            ```

            **After installation:**
            - Binary: `/opt/container-tools/p2kb-mcp/bin/p2kb-mcp`
            - Symlink: `/opt/container-tools/bin/p2kb-mcp`
            - Cache: `/opt/container-tools/var/cache/p2kb-mcp/`

            ---

            ### Option 2: Standalone Package

            Single-platform packages. Extract and place in your preferred location.

            | Platform | File |
            |----------|------|
            | Linux AMD64 | `p2kb-mcp-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz` |
            | Linux ARM64 | `p2kb-mcp-${{ steps.version.outputs.VERSION }}-linux-arm64.tar.gz` |
            | macOS Apple Silicon | `p2kb-mcp-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz` |
            | macOS Intel | `p2kb-mcp-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz` |
            | Windows AMD64 | `p2kb-mcp-${{ steps.version.outputs.VERSION }}-windows-amd64.zip` |
            | Windows ARM64 | `p2kb-mcp-${{ steps.version.outputs.VERSION }}-windows-arm64.zip` |

            **Installation:**
            ```bash
            # Linux/macOS - extract and place in /opt
            tar -xzf p2kb-mcp-${{ steps.version.outputs.VERSION }}-<platform>.tar.gz
            sudo mv p2kb-mcp /opt/

            # Windows - extract zip to desired location
            ```

            **Cache locations:**
            - Linux/macOS: `.cache/` directory next to the binary
            - Windows: `%LOCALAPPDATA%\p2kb-mcp\cache\`

            ---

            ### Platform Notes
            - **macOS**: ${{ steps.check-signed.outputs.MACOS_NOTE }}

            ### Features
            - Search P2 Knowledge Base by key or term
            - Browse categories (PASM2, Spin2, Architecture, etc.)
            - Fetch documentation with automatic caching
            - Batch operations for multiple keys
            - Related instruction lookup

            ### Checksums
            See `checksums.txt` for SHA256 checksums of all files.
